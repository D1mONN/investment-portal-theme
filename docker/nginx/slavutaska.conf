# Конфігурація сайту Славутського інвестиційного порталу

# Редірект з HTTP на HTTPS
server {
    listen 80;
    server_name slavutska.local localhost;
    
    # Let's Encrypt verification
    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }
    
    # Редірект на HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# Основний HTTPS сервер
server {
    listen 443 ssl http2;
    server_name slavutska.local localhost;
    
    root /var/www/html;
    index index.php index.html index.htm;
    
    # SSL налаштування
    ssl_certificate /etc/nginx/ssl/slavutska.crt;
    ssl_certificate_key /etc/nginx/ssl/slavutska.key;
    
    # Додаткові заголовки безпеки
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Robots-Tag "index, follow, snippet, archive" always;
    
    # Налаштування логування для цього сайту
    access_log /var/log/nginx/slavutska_access.log performance;
    error_log /var/log/nginx/slavutska_error.log;
    
    # Rate limiting для різних зон
    location /wp-login.php {
        limit_req zone=login burst=5 nodelay;
        include /etc/nginx/conf.d/php_location.conf;
    }
    
    location /wp-json/ {
        limit_req zone=api burst=20 nodelay;
        include /etc/nginx/conf.d/php_location.conf;
    }
    
    # Заборона доступу до чутливих файлів
    location ~* /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~* wp-config\.php {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~* /(wp-content|wp-includes|wp-admin).*\.php$ {
        location ~ /wp-admin/admin-ajax\.php$ {
            include /etc/nginx/conf.d/php_location.conf;
        }
        location ~ /wp-admin/ {
            include /etc/nginx/conf.d/php_location.conf;
        }
        location ~ ^/(wp-content|wp-includes)/ {
            deny all;
        }
    }
    
    # Заборона доступу до логів та конфігурацій
    location ~* \.(log|sql|conf|fla|psd|ini|sh|inc|swp|dist)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Заборона доступу до backup файлів
    location ~* \.(bak|backup|old|orig|original|tmp)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Оптимізація статичних файлів
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary Accept-Encoding;
        access_log off;
        
        # Обробка CORS для шрифтів
        location ~* \.(woff|woff2|ttf|eot)$ {
            add_header Access-Control-Allow-Origin "*";
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # Кешування для медіа файлів
    location ~* \.(mp4|mp3|avi|mov|wmv|flv|webm)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # Кешування для PDF та документів
    location ~* \.(pdf|doc|docx|xls|xlsx|ppt|pptx)$ {
        expires 1M;
        add_header Cache-Control "public";
        add_header Content-Disposition "inline";
    }
    
    # XML файли (sitemap, feeds)
    location ~* \.(xml|rss|atom)$ {
        expires 1h;
        add_header Cache-Control "public";
    }
    
    # Спеціальні маршрути WordPress
    location = /favicon.ico {
        log_not_found off;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location = /robots.txt {
        log_not_found off;
        access_log off;
        expires 1d;
        add_header Cache-Control "public";
    }
    
    # Nginx health check
    location = /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # WordPress REST API з кешуванням
    location ~ ^/wp-json/wp/v2/(posts|pages|media) {
        limit_req zone=api burst=30 nodelay;
        
        # Кешування GET запитів
        set $cache_uri $request_uri;
        if ($request_method != GET) {
            set $cache_uri 'null cache';
        }
        
        fastcgi_cache WORDPRESS;
        fastcgi_cache_valid 200 301 302 10m;
        fastcgi_cache_valid 404 1m;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache_key $scheme$request_method$host$cache_uri;
        
        add_header X-Cache-Status $upstream_cache_status;
        
        include /etc/nginx/conf.d/php_location.conf;
    }
    
    # Основна обробка PHP файлів з кешуванням
    location ~ \.php$ {
        limit_req zone=general burst=50 nodelay;
        
        # FastCGI кеш
        fastcgi_cache WORDPRESS;
        fastcgi_cache_valid 200 301 302 60m;
        fastcgi_cache_valid 404 1m;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache_key $scheme$request_method$host$request_uri;
        
        add_header X-Cache-Status $upstream_cache_status;
        
        include /etc/nginx/conf.d/php_location.conf;
    }
    
    # WordPress pretty URLs
    location / {
        try_files $uri $uri/ /index.php$is_args$args;
        
        # Додаткові заголовки для SEO
        add_header Link '<https://$server_name$request_uri>; rel="canonical"';
    }
    
    # Обробка WordPress uploads
    location ~* ^/wp-content/uploads/.*\.(php|php5|phtml|pl|py|jsp|asp|sh|cgi)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Захист wp-includes
    location ~* ^/wp-includes/.*\.php$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Особлива обробка wp-cron
    location = /wp-cron.php {
        fastcgi_read_timeout 300;
        include /etc/nginx/conf.d/php_location.conf;
    }
    
    # Gzip для окремих типів файлів
    location ~* \.(svg|js|css)$ {
        gzip_static on;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# Додатковий сервер для розробки без SSL
server {
    listen 8080;
    server_name localhost;
    
    root /var/www/html;
    index index.php index.html index.htm;
    
    access_log /var/log/nginx/dev_access.log main;
    error_log /var/log/nginx/dev_error.log;
    
    location ~ \.php$ {
        include /etc/nginx/conf.d/php_location.conf;
    }
    
    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }
}